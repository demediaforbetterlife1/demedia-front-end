<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Photo Storage</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #000;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .info { color: #2196F3; }
        input[type="file"] {
            margin: 10px 0;
        }
        img {
            max-width: 200px;
            margin: 10px;
            border: 2px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>üîç Photo Storage Test</h1>
    
    <div class="section">
        <h2>Step 1: Check IndexedDB Support</h2>
        <button onclick="checkIndexedDB()">Check IndexedDB</button>
        <div id="indexeddb-result" class="log"></div>
    </div>

    <div class="section">
        <h2>Step 2: Test Photo Upload</h2>
        <input type="file" id="photoInput" accept="image/*">
        <button onclick="testPhotoUpload()">Upload & Store Photo</button>
        <div id="upload-result" class="log"></div>
    </div>

    <div class="section">
        <h2>Step 3: List Stored Photos</h2>
        <button onclick="listPhotos()">List All Photos</button>
        <div id="photos-list" class="log"></div>
    </div>

    <div class="section">
        <h2>Step 4: Display Photos</h2>
        <button onclick="displayPhotos()">Display All Photos</button>
        <div id="photos-display"></div>
    </div>

    <div class="section">
        <h2>Step 5: Clear All Photos</h2>
        <button onclick="clearAllPhotos()" style="background: #f44336;">Clear Storage</button>
        <div id="clear-result" class="log"></div>
    </div>

    <script>
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            element.scrollTop = element.scrollHeight;
        }

        function checkIndexedDB() {
            const result = document.getElementById('indexeddb-result');
            result.innerHTML = '';
            
            if (!('indexedDB' in window)) {
                log('indexeddb-result', '‚ùå IndexedDB not supported', 'error');
                return;
            }
            
            log('indexeddb-result', '‚úÖ IndexedDB is supported', 'success');
            
            // Try to open database
            const request = indexedDB.open('demedia-photos', 1);
            
            request.onerror = () => {
                log('indexeddb-result', '‚ùå Failed to open database', 'error');
            };
            
            request.onsuccess = () => {
                log('indexeddb-result', '‚úÖ Database opened successfully', 'success');
                const db = request.result;
                log('indexeddb-result', `üìä Database version: ${db.version}`, 'info');
                log('indexeddb-result', `üìä Object stores: ${Array.from(db.objectStoreNames).join(', ')}`, 'info');
                db.close();
            };
            
            request.onupgradeneeded = (event) => {
                log('indexeddb-result', 'üîß Database needs upgrade', 'info');
                const db = event.target.result;
                
                if (!db.objectStoreNames.contains('photos')) {
                    db.createObjectStore('photos', { keyPath: 'id' });
                    log('indexeddb-result', '‚úÖ Created photos store', 'success');
                }
                
                if (!db.objectStoreNames.contains('metadata')) {
                    const metadataStore = db.createObjectStore('metadata', { keyPath: 'id' });
                    metadataStore.createIndex('createdAt', 'createdAt', { unique: false });
                    metadataStore.createIndex('lastAccessed', 'lastAccessed', { unique: false });
                    metadataStore.createIndex('postIds', 'postIds', { unique: false, multiEntry: true });
                    log('indexeddb-result', '‚úÖ Created metadata store with indexes', 'success');
                }
            };
        }

        async function testPhotoUpload() {
            const result = document.getElementById('upload-result');
            result.innerHTML = '';
            
            const fileInput = document.getElementById('photoInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                log('upload-result', '‚ùå Please select a photo first', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            log('upload-result', `üì∏ Selected file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 'info');
            
            try {
                // Generate ID
                const photoId = crypto.randomUUID();
                log('upload-result', `üÜî Generated ID: ${photoId}`, 'info');
                
                // Open database
                const db = await openDatabase();
                log('upload-result', '‚úÖ Database opened', 'success');
                
                // Store photo
                const transaction = db.transaction(['photos', 'metadata'], 'readwrite');
                
                // Store blob
                const photoStore = transaction.objectStore('photos');
                photoStore.put({ id: photoId, data: file });
                log('upload-result', '‚úÖ Photo blob stored', 'success');
                
                // Store metadata
                const metadataStore = transaction.objectStore('metadata');
                const metadata = {
                    id: photoId,
                    filename: file.name,
                    mimeType: file.type,
                    size: file.size,
                    width: 0,
                    height: 0,
                    createdAt: Date.now(),
                    lastAccessed: Date.now(),
                    postIds: [],
                    compressed: false
                };
                metadataStore.put(metadata);
                log('upload-result', '‚úÖ Metadata stored', 'success');
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = reject;
                });
                
                log('upload-result', `‚úÖ Photo stored successfully with ID: ${photoId}`, 'success');
                log('upload-result', `üîó Local URL: local-photo://${photoId}`, 'info');
                
                db.close();
            } catch (error) {
                log('upload-result', `‚ùå Error: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function listPhotos() {
            const result = document.getElementById('photos-list');
            result.innerHTML = '';
            
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['metadata'], 'readonly');
                const store = transaction.objectStore('metadata');
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const photos = request.result;
                    log('photos-list', `üìä Found ${photos.length} photos in storage`, 'success');
                    
                    photos.forEach((photo, index) => {
                        log('photos-list', `${index + 1}. ${photo.filename} (${photo.id})`, 'info');
                        log('photos-list', `   Size: ${(photo.size / 1024).toFixed(2)} KB, Created: ${new Date(photo.createdAt).toLocaleString()}`, 'info');
                    });
                    
                    if (photos.length === 0) {
                        log('photos-list', '‚ö†Ô∏è No photos found in storage', 'error');
                    }
                };
                
                request.onerror = () => {
                    log('photos-list', '‚ùå Failed to list photos', 'error');
                };
                
                db.close();
            } catch (error) {
                log('photos-list', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function displayPhotos() {
            const display = document.getElementById('photos-display');
            display.innerHTML = '';
            
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['photos', 'metadata'], 'readonly');
                
                const metadataStore = transaction.objectStore('metadata');
                const metadataRequest = metadataStore.getAll();
                
                metadataRequest.onsuccess = async () => {
                    const photos = metadataRequest.result;
                    
                    for (const photo of photos) {
                        const photoStore = transaction.objectStore('photos');
                        const photoRequest = photoStore.get(photo.id);
                        
                        photoRequest.onsuccess = () => {
                            const photoData = photoRequest.result;
                            if (photoData && photoData.data) {
                                const url = URL.createObjectURL(photoData.data);
                                const img = document.createElement('img');
                                img.src = url;
                                img.alt = photo.filename;
                                img.title = `${photo.filename} (${photo.id})`;
                                display.appendChild(img);
                            }
                        };
                    }
                };
                
                db.close();
            } catch (error) {
                console.error('Display error:', error);
            }
        }

        async function clearAllPhotos() {
            const result = document.getElementById('clear-result');
            result.innerHTML = '';
            
            if (!confirm('Are you sure you want to delete all photos?')) {
                return;
            }
            
            try {
                const db = await openDatabase();
                const transaction = db.transaction(['photos', 'metadata'], 'readwrite');
                
                transaction.objectStore('photos').clear();
                transaction.objectStore('metadata').clear();
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = reject;
                });
                
                log('clear-result', '‚úÖ All photos cleared', 'success');
                db.close();
            } catch (error) {
                log('clear-result', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('demedia-photos', 1);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(new Error('Failed to open database'));
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('metadata')) {
                        const metadataStore = db.createObjectStore('metadata', { keyPath: 'id' });
                        metadataStore.createIndex('createdAt', 'createdAt', { unique: false });
                        metadataStore.createIndex('lastAccessed', 'lastAccessed', { unique: false });
                        metadataStore.createIndex('postIds', 'postIds', { unique: false, multiEntry: true });
                    }
                };
            });
        }
    </script>
</body>
</html>
